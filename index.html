<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Zexma Bootloader ‚Äî Web Updater</title>
    <style>
      :root {
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI",
          Roboto, "Helvetica Neue", Arial;
      }
      body {
        max-width: 900px;
        margin: 28px auto;
        padding: 20px;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 12px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      button {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        background: #fff;
        cursor: pointer;
      }
      button.primary {
        background: #0b74de;
        color: #fff;
        border: none;
      }
      pre#log {
        height: 220px;
        overflow: auto;
        background: #0f1720;
        color: #e6eef8;
        padding: 12px;
        border-radius: 8px;
      }
      input[type="file"] {
        display: inline-block;
      }
      progress {
        width: 100%;
        height: 18px;
      }
      .meta {
        margin-top: 12px;
      }
      .badge {
        display: inline-block;
        padding: 6px 8px;
        border-radius: 8px;
        background: #f0f4f8;
        margin-right: 6px;
      }
      .small {
        font-size: 13px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>Zexma bootloader ‚Äî WebUSB firmware updater</h1>

    <div class="row">
      <button id="btnConnect" class="primary">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
      <input id="fileInput" type="file" accept=".bfc" />
      <button id="btnStart" disabled>‚¨ÜÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—à–∏–≤–∫—É</button>
    </div>

    <div class="meta">
      <span class="badge" id="manufacturer">‚Äî</span>
      <span class="badge" id="product">‚Äî</span>
      <span class="badge" id="serial">‚Äî</span>
      <div class="small" id="fwInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ—à–∏–≤–∫–µ: ‚Äî</div>
    </div>

    <div style="margin-top: 14px">
      <progress id="progress" value="0" max="1"></progress>
    </div>

    <pre id="log">
–õ–æ–≥–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è...
</pre
    >

    <script>
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∏–∑ —Ç–≤–æ–∏—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
      const VENDOR_ID = 0x03ea;
      const PRODUCT_ID = 0xb002;
      const INTERFACE_NUMBER = 0; // –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å 0
      const ENDPOINT_OUT = 1; // bulk OUT endpoint (python –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 0x01)
      const ENDPOINT_IN = 1; // bulk IN endpoint address 0x81 -> number 1 for transferIn

      let device = null;
      let selectedFile = null;

      const $ = (id) => document.getElementById(id);
      function log(...args) {
        const el = $("log");
        el.textContent += "\n" + args.join(" ");
        el.scrollTop = el.scrollHeight;
      }

      function setMeta({ manufacturer, product, serial }) {
        $("manufacturer").textContent = manufacturer || "‚Äî";
        $("product").textContent = product || "‚Äî";
        $("serial").textContent = serial || "‚Äî";
      }

      async function connect() {
        try {
          log("–ó–∞–ø—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...");
          const filters = [{ vendorId: VENDOR_ID, productId: PRODUCT_ID }];
          const d = await navigator.usb.requestDevice({ filters });
          device = d;
          await openAndClaim();
          log("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ");
          setMeta({
            manufacturer: device.manufacturerName,
            product: device.productName,
            serial: device.serialNumber,
          });
          await readCurrentFirmware();
          $("btnStart").disabled = !selectedFile;
        } catch (e) {
          log("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:", e && e.message ? e.message : e);
        }
      }

      async function openAndClaim() {
        if (!device) throw new Error("–ù–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞");
        if (!device.opened) {
          await device.open();
          log("device.open() –≤—ã–ø–æ–ª–Ω–µ–Ω");
        }
        if (device.configuration === null) {
          await device.selectConfiguration(1);
          log("–í—ã–±—Ä–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 1");
        }
        try {
          await device.claimInterface(INTERFACE_NUMBER);
          log("–ó–∞—è–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å", INTERFACE_NUMBER);
        } catch (err) {
          log("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—è–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:", err.message || err);
          throw err;
        }
      }

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è controlTransferOut —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –ø–æ—Ö–æ–∂–∏–º –Ω–∞ python ctrl_transfer(0x41, bRequest, ... , data)
      async function ctrlOut(request, dataArrayBuffer) {
        // –≤ WebUSB requestType –∏ recipient –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —è–≤–Ω–æ. Python –∏—Å–ø–æ–ª—å–∑—É–µ—Ç bmRequestType=0x41.
        // 0x41: host->device, type=vendor, recipient=interface (roughly). –ò—Å–ø–æ–ª—å–∑—É–µ–º recipient: 'interface'
        return device.controlTransferOut(
          {
            requestType: "vendor",
            recipient: "interface",
            request: request,
            value: 0,
            index: 0,
          },
          dataArrayBuffer ? new Uint8Array(dataArrayBuffer) : undefined
        );
      }

      async function readOnePacket(timeout = 3000) {
        // transferIn(endpointNumber, length)
        const res = await device.transferIn(ENDPOINT_IN, 64);
        if (res.status !== "ok")
          throw new Error("transferIn status: " + res.status);
        return new Uint8Array(res.data.buffer);
      }

      function decodeNameAndVersion(header64) {
        // header64 is Uint8Array length 64, same as python: name 0..15, version 16..19 little-endian
        const nameBytes = header64.slice(0, 16);
        const zeroIndex = nameBytes.indexOf(0);
        const name = new TextDecoder("ascii", { fatal: false })
          .decode(nameBytes.slice(0, zeroIndex >= 0 ? zeroIndex : undefined))
          .replace(/\u0000/g, "")
          .trim();
        const verBytes = header64.slice(16, 20);
        const verInt =
          verBytes[0] |
          (verBytes[1] << 8) |
          (verBytes[2] << 16) |
          (verBytes[3] << 24);
        const verHex = ("00000000" + verInt.toString(16)).slice(-8);
        const version =
          verHex.slice(0, 2) +
          "." +
          verHex.slice(2, 5) +
          "." +
          verHex.slice(5, 8);
        return { name: name || "---", version };
      }

      async function readCurrentFirmware() {
        try {
          log("–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ—à–∏–≤–∫–∏...");
          // python: device.ctrl_transfer(0x41, 1, 0, 0, [0x0]) then read
          await ctrlOut(1, [0x0]);
          const pkt = await readOnePacket();
          if (pkt && pkt.length > 0) {
            const info = decodeNameAndVersion(pkt.slice(1));
            $(
              "fwInfo"
            ).textContent = `–¢–µ–∫—É—â–∞—è –ø—Ä–æ—à–∏–≤–∫–∞: ${info.name} v${info.version}`;
            log("–¢–µ–∫—É—â–∞—è –ø—Ä–æ—à–∏–≤–∫–∞:", info.name, "v" + info.version);
          } else {
            log("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≤–µ—Ä—Å–∏–∏");
          }
        } catch (err) {
          log("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏:", err && err.message ? err.message : err);
        }
      }

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–ø–µ—Ä–≤—ã–µ 64 –±–∞–π—Ç–∞)
      async function sendHeader(header64) {
        log(
          "–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ (controlTransferOut request=1, data=[0x1])"
        );
        await ctrlOut(1, [0x1]);
        const pkt = await readOnePacket();
        if (pkt[0] !== 1 && pkt[0] !== 0 && pkt[0] !== 2) {
          // –≤ python –æ–∂–∏–¥–∞–ª–∏ FirmwarePackets.Ready2ReceiveHeader == 1
          // –µ—Å–ª–∏ –Ω–µ ready ‚Äî –æ—à–∏–±–∫–∞
          throw new Error(
            "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≥–æ—Ç–æ–≤–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫. –ü–∞–∫–µ—Ç[0]=" + pkt[0]
          );
        }
        log(
          "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ—Ç–æ–≤–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫, –æ—Ç–ø—Ä–∞–≤–ª—è—é 64 –±–∞–π—Ç–∞ —á–µ—Ä–µ–∑ BULK OUT"
        );
        const res = await device.transferOut(ENDPOINT_OUT, header64);
        if (res.status !== "ok")
          throw new Error("transferOut header status: " + res.status);
        log("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, —á–∏—Ç–∞—é –æ—Ç–≤–µ—Ç...");
        const headerResp = await readOnePacket();
        if (headerResp[0] === 3) {
          throw new Error("WrongHeader (—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∏–ª–æ 3)");
        }
        // headerResp —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è –∏ –≤–µ—Ä—Å–∏—é (–∫–∞–∫ –≤ python)
        const info = decodeNameAndVersion(headerResp.slice(1));
        log("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–Ω—è—Ç, –∏–º—è:", info.name, "–≤–µ—Ä—Å–∏—è v" + info.version);
        return info;
      }

      async function requestBodyAndSend(firmwareBytes, onProgress) {
        log(
          "–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–µ–ª–∞ –ø—Ä–æ—à–∏–≤–∫–∏ (controlTransferOut request=1, data=[2])"
        );
        // SoftwarePackets.RequestSendBody == 2
        await ctrlOut(1, [2]);
        const ready = await readOnePacket();
        // FirmwarePackets.Ready2ReceiveBody == 4 in python enum
        if (ready[0] !== 4) {
          throw new Error(
            "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≥–æ—Ç–æ–≤–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–µ–ª–æ –ø—Ä–æ—à–∏–≤–∫–∏. –û—Ç–≤–µ—Ç: " + ready[0]
          );
        }
        log("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–µ–º—É —Ç–µ–ª–∞ –ø—Ä–æ—à–∏–≤–∫–∏, –Ω–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É...");

        const CHUNK = 64;
        let sent = 0;
        const total = firmwareBytes.length;
        for (let offset = 0; offset < total; offset += CHUNK) {
          const slice = firmwareBytes.slice(
            offset,
            Math.min(offset + CHUNK, total)
          );
          const res = await device.transferOut(ENDPOINT_OUT, slice);
          if (res.status !== "ok")
            throw new Error("transferOut body status: " + res.status);
          sent += slice.length;
          onProgress(sent / total);
        }
        log("–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∂–¥—É —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞...");
        const final = await readOnePacket();
        if (final[0] === 5) {
          log("–ü—Ä–æ—à–∏–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ (–∫–æ–¥ 5)");
          return { ok: true };
        } else {
          log("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∫–æ–¥:", final[0]);
          return { ok: false, code: final[0] };
        }
      }

      // UI handlers
      $("btnConnect").addEventListener("click", connect);
      $("fileInput").addEventListener("change", (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (!f) {
          selectedFile = null;
          $("btnStart").disabled = true;
          return;
        }
        selectedFile = f;
        log("–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª", f.name, f.size, "–±–∞–π—Ç");
        $("btnStart").disabled = device == null;
      });

      $("btnStart").addEventListener("click", async () => {
        if (!device) {
          log("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ");
          return;
        }
        if (!selectedFile) {
          log("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ .bfc —Ñ–∞–π–ª");
          return;
        }
        try {
          // —á–∏—Ç–∞–µ–º —Ñ–∞–π–ª
          const arrayBuffer = await selectedFile.arrayBuffer();
          const bytes = new Uint8Array(arrayBuffer);
          if (bytes.length <= 64) {
            log("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π");
            return;
          }
          const header = bytes.slice(0, 64);
          const body = bytes.slice(64);

          // 1) –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º header (–∫–æ–Ω—Ç—Ä–æ–ª–æ–º –∑–∞–ø—Ä–æ—Å=1 data=[1], –ø–æ—Ç–æ–º bulk out header)
          const info = await sendHeader(header);
          // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          if (
            !confirm(
              "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—à–∏–≤–∫—É –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –Ω–∞: " +
                info.name +
                " v" +
                info.version +
                "?"
            )
          ) {
            log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
            return;
          }

          // 2) –∑–∞–ø—Ä–æ—Å–∏—Ç—å ready –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–ª–æ
          $("progress").value = 0;
          const result = await requestBodyAndSend(body, (p) => {
            $("progress").value = p;
          });
          if (result.ok) {
            alert("Firmware update done");
          } else {
            alert("Firmware update error, code:" + result.code);
          }
        } catch (err) {
          log(
            "–û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: " +
              (err && err.message ? err.message : err)
          );
        }
      });

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π attempt –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
      (async function tryAuto() {
        if (!("usb" in navigator)) {
          log(
            "WebUSB –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebUSB."
          );
          return;
        }
        try {
          const devices = await navigator.usb.getDevices();
          const found = devices.find(
            (d) => d.vendorId === VENDOR_ID && d.productId === PRODUCT_ID
          );
          if (found) {
            device = found;
            await openAndClaim();
            log("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ —Ä–∞–Ω–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ");
            setMeta({
              manufacturer: device.manufacturerName,
              product: device.productName,
              serial: device.serialNumber,
            });
            await readCurrentFirmware();
            $("btnStart").disabled = !selectedFile;
          }
        } catch (e) {
          log("–ê–≤—Ç–æ-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:", e && e.message ? e.message : e);
        }
      })();
    </script>
  </body>
</html>
